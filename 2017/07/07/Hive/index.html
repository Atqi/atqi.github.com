<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />














  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="hive," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="Hive的使用">
<meta name="keywords" content="hive">
<meta property="og:type" content="article">
<meta property="og:title" content="Hive">
<meta property="og:url" content="http://atqi.github.io/2017/07/07/Hive/index.html">
<meta property="og:site_name" content="Wyatt&#39;s blog">
<meta property="og:description" content="Hive的使用">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://atqi.github.io/images/udaf.png">
<meta property="og:updated_time" content="2017-07-23T15:54:53.942Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hive">
<meta name="twitter:description" content="Hive的使用">
<meta name="twitter:image" content="http://atqi.github.io/images/udaf.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: 'P70I32CZZY',
      apiKey: 'ca830abc2a5f90e6899f2fcb15b01569',
      indexName: 'blog',
      hits: {"per_page":10},
      labels: {"input_placeholder":"搜索文章","hits_empty":"没有找到结果: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://atqi.github.io/2017/07/07/Hive/"/>





  <title> Hive | Wyatt's blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?b7ee5c024043c8ecd0e33f636ce4921d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Wyatt's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://atqi.github.io/2017/07/07/Hive/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄文启">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wyatt's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Hive
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-07T22:47:10+08:00">
                2017-07-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/bigdata/" itemprop="url" rel="index">
                    <span itemprop="name">bigdata</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/bigdata/hadoop/" itemprop="url" rel="index">
                    <span itemprop="name">hadoop</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/07/Hive/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/07/07/Hive/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Hive的使用</p>
<a id="more"></a>
<h2 id="Hive-QL"><a href="#Hive-QL" class="headerlink" title="Hive QL"></a>Hive QL</h2><p>Hive 的 sql “方言”， 称为 HiveQL。</p>
<p>SQL 和 HiveQL 的概要比较</p>
<table>
<thead>
<tr>
<th>特性</th>
<th>SQL</th>
<th>HiveQL</th>
</tr>
</thead>
<tbody>
<tr>
<td>更新</td>
<td>UPDATA</td>
<td>INSERT</td>
</tr>
<tr>
<td>事务</td>
<td>支持</td>
<td>支持(表级和分区级)</td>
</tr>
<tr>
<td>索引</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>延迟</td>
<td>亚秒级</td>
<td>分钟级</td>
</tr>
<tr>
<td>数据类型</td>
<td>整数、浮点数、定点数、文本和二进制串、时间</td>
<td>整数、浮点数、布尔值、文本和二进制串、时间戳、数组、映射、结构</td>
</tr>
<tr>
<td>函数</td>
<td>数百个内置函数</td>
<td>几十个内置函数</td>
</tr>
<tr>
<td>多表插入</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>Create table as select</td>
<td>一部分支持</td>
<td>支持</td>
</tr>
<tr>
<td>选择</td>
<td>SQL-92</td>
<td>FROM子句中只能有一个表或者视图。支持偏序的SORT BY。 可限制返回行数量的LIMIT</td>
</tr>
<tr>
<td>子查询</td>
<td>在任何字句中支持相关的或者不相关的</td>
<td>只能在FROM子句中(不支持相关子查询)</td>
</tr>
<tr>
<td>视图</td>
<td>可更新</td>
<td>只读</td>
</tr>
<tr>
<td>拓展点</td>
<td>用户自定义函数、存储过程</td>
<td>用户自定义函数、MapReduce脚本</td>
</tr>
</tbody>
</table>
<h3 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h3><table>
<thead>
<tr>
<th>类别</th>
<th>类型</th>
<th>描述</th>
<th>文字示例</th>
</tr>
</thead>
<tbody>
<tr>
<td>基本数据类型</td>
<td>TINYINT</td>
<td>1B有符号整数，-128~127</td>
<td>1</td>
</tr>
<tr>
<td>基本数据类型</td>
<td>SMALLINT</td>
<td>2B有符号整数，-32768~32767</td>
<td>1</td>
</tr>
<tr>
<td>基本数据类型</td>
<td>INT</td>
<td>4B有符号整数，-2147483648~2147483647</td>
<td>1</td>
</tr>
<tr>
<td>基本数据类型</td>
<td>BIGINT</td>
<td>8B有符号整数，-9223372036854775808~9223372036854775807</td>
<td>1</td>
</tr>
<tr>
<td>基本数据类型</td>
<td>FLOAT</td>
<td>4B单精度浮点数</td>
<td>1.0</td>
</tr>
<tr>
<td>基本数据类型</td>
<td>DOUBLE</td>
<td>8B双精度浮点数</td>
<td>1.0</td>
</tr>
<tr>
<td>基本数据类型</td>
<td>BOOLEAN</td>
<td>true/false</td>
<td>true</td>
</tr>
<tr>
<td>基本数据类型</td>
<td>STRING</td>
<td>字符串</td>
<td>‘a’,”a”</td>
</tr>
<tr>
<td>基本数据类型</td>
<td>BINARY</td>
<td>字节数组</td>
<td></td>
</tr>
<tr>
<td>基本数据类型</td>
<td>TIMESTAMP</td>
<td>精度到纳秒的时间戳</td>
<td>1325502245000，’2012-01-02 03:04:05.123456789’</td>
</tr>
<tr>
<td>复杂数据类型</td>
<td>ARRAY</td>
<td>一组有序字段。字段的类型必须相同</td>
<td>array(1,2)</td>
</tr>
<tr>
<td>复杂数据类型</td>
<td>MAP</td>
<td>一组无序的键值对。见得类型必须是原子的；值可以是任何类型。同一个映射的键的类型必须相同，值的类型也必须相同</td>
<td>map(‘a’,1,’b’,2)</td>
</tr>
<tr>
<td>复杂数据类型</td>
<td>STRUCT</td>
<td>一组命名的字段，字段的类型可以不同</td>
<td>struct(‘a’,1,1.0)</td>
</tr>
</tbody>
</table>
<ol>
<li>array(), map(), struct()三个函数都是HIVE的内置函数</li>
<li>列命名col1， col2， col3等</li>
</ol>
<h3 id="复杂类型"><a href="#复杂类型" class="headerlink" title="复杂类型"></a>复杂类型</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> complex (</div><div class="line">    col1 <span class="built_in">ARRAY</span>&lt;<span class="built_in">INT</span>&gt;,</div><div class="line">    col2 <span class="keyword">MAP</span>&lt;<span class="keyword">STRING</span>, <span class="built_in">INT</span>&gt;,</div><div class="line">    col3 <span class="keyword">STRUCT</span>&lt;a:<span class="keyword">STRING</span>, b:<span class="built_in">INT</span>, c:<span class="keyword">DOUBLE</span>&gt;</div><div class="line">);</div></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">hive&gt; SELECT col1[0], col2['b'], col3.c FROM complex;</div><div class="line">1   2   1.0</div></pre></td></tr></table></figure>
<h3 id="操作与函数"><a href="#操作与函数" class="headerlink" title="操作与函数"></a>操作与函数</h3><p>函数分为几大类(在hive shell中输入SHOW FUNCTION可以得到):</p>
<ul>
<li>数学和统计函数</li>
<li>字符串函数</li>
<li>日期函数</li>
<li>条件函数</li>
<li>聚集函数</li>
<li>处理XML和JSON函数</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">-- 获取某个函数帮助</div><div class="line">hive&gt; DESCRIBE FUNCTION length;</div><div class="line">length(str|binary) - Returns the length of str or number of bytes in binary data</div></pre></td></tr></table></figure>
<h4 id="类型转换"><a href="#类型转换" class="headerlink" title="类型转换"></a>类型转换</h4><p>隐式转换：<br>所有整数、float、string 都能转换成double<br>timestamp能转换为String<br>显示转换(cast):<br>CASE(‘1’ AS INT) 将字符串1 转为 1<br>CASE(‘x’ AS INT) 强转失败，返回 NULL</p>
<h2 id="表"><a href="#表" class="headerlink" title="表"></a>表</h2><p>hive 的表在逻辑上由存储的数据和描述表中的数据形式的相关元数据组成。<br>数据一般存放在HDFS上或者其他Hadoop文件系统中。<br>元数据存放在关系数据库中，比如mySql。</p>
<h3 id="托管表和外部表"><a href="#托管表和外部表" class="headerlink" title="托管表和外部表"></a>托管表和外部表</h3><p>托管表：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> managed_table (dummy <span class="keyword">STRING</span>);</div><div class="line"><span class="keyword">LOAD</span> <span class="keyword">DATA</span> INPATH <span class="string">'/user/tom/data.txt'</span> <span class="keyword">INTO</span> <span class="keyword">table</span> managed_table;</div></pre></td></tr></table></figure></p>
<p>把文件 hdfs：//user/tom/data.txt 移动到 managed_table的仓库目录中，即hdfs://user/hive/warehouse/managed_table。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">--删除</span></div><div class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> managed_table;</div></pre></td></tr></table></figure>
<p>外部表<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">EXTERNAL</span> <span class="keyword">TABLE</span> external_table (dummy <span class="keyword">STRING</span>)</div><div class="line">LOCATION <span class="string">'/user/tom/external_table'</span>;</div><div class="line"><span class="keyword">LOAD</span> <span class="keyword">DATA</span> INPATH <span class="string">'user/tom/data.txt'</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> external_table;</div></pre></td></tr></table></figure></p>
<p>hive 不会移动数据到数据仓库，也不会检查目录是否存在，删除表时也只会删除元数据。</p>
<h3 id="分区和桶"><a href="#分区和桶" class="headerlink" title="分区和桶"></a>分区和桶</h3><p>分区是在创建表的时候用PARTIONED BY 子句定义的。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">logs</span> (ts <span class="built_in">BIGINT</span>, line <span class="keyword">STRING</span>)</div><div class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> (dt <span class="keyword">STRING</span>, country <span class="keyword">STRING</span>);</div></pre></td></tr></table></figure>
<p>加载数据时要指定分区</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">LOAD</span> <span class="keyword">DATA</span> <span class="keyword">LOCAL</span> INPATH <span class="string">'input/hive/partitions/file1'</span></div><div class="line"><span class="keyword">INTO</span> <span class="keyword">TABLE</span> <span class="keyword">logs</span></div><div class="line"><span class="keyword">PARTITION</span> (dt=<span class="string">'2017-01-01'</span>, country=<span class="string">'GB'</span>);</div></pre></td></tr></table></figure>
<p>显示分区<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hive&gt; SHOW PARTITIONS logs;</div></pre></td></tr></table></figure></p>
<p>按分区查询<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> ts, dt, line</div><div class="line"><span class="keyword">FROM</span> <span class="keyword">logs</span></div><div class="line"><span class="keyword">WHERE</span> country=<span class="string">'GB'</span>;</div></pre></td></tr></table></figure></p>
<h4 id="桶"><a href="#桶" class="headerlink" title="桶"></a>桶</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> bucketed_users (<span class="keyword">id</span> <span class="built_in">INT</span>, <span class="keyword">name</span> <span class="keyword">STRING</span>)</div><div class="line">CLUSTERED <span class="keyword">BY</span> (<span class="keyword">id</span>) <span class="keyword">INTO</span> <span class="number">4</span> BUCKETS;</div></pre></td></tr></table></figure>
<p>对id进行hash取模，放到4个桶中</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">--对数据取样</div><div class="line">hive&gt; SELECT * FROM bucketed_users</div><div class="line">    &gt; TABLESAMPLE(BUCKET 1 OUT OF 4 ON id);</div></pre></td></tr></table></figure>
<p>这样大约得到1/4的数据</p>
<h3 id="存储格式"><a href="#存储格式" class="headerlink" title="存储格式"></a>存储格式</h3><p>HIVE从两个维度对表的存储进行管理：</p>
<ul>
<li>行格式   SerDe(序列化和反序列化工具)</li>
<li>文件格式<br>默认行内分隔符 ^A<br>集合元素的默认分隔符 ^B, 用于分割ARRAY STRUCT 或者 MAP的键值对中的元素</li>
</ul>
<p>CREATE TABLE … 默认为：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> ...</div><div class="line"><span class="keyword">ROW</span> <span class="keyword">FORMAT</span> <span class="keyword">DELIMITED</span></div><div class="line">  <span class="keyword">FIELDS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">'\001'</span></div><div class="line">  COLLECTION ITEMS <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">'\002'</span></div><div class="line">  <span class="keyword">MAP</span> <span class="keyword">KEYS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">'\003'</span></div><div class="line">  <span class="keyword">LINES</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">'\n'</span></div><div class="line">  <span class="keyword">STORED</span> <span class="keyword">AS</span> TEXTFILE;</div></pre></td></tr></table></figure></p>
<h4 id="二进制存储格式：-顺序文件、-Avro数据文件以及RCFile"><a href="#二进制存储格式：-顺序文件、-Avro数据文件以及RCFile" class="headerlink" title="二进制存储格式： 顺序文件、 Avro数据文件以及RCFile"></a>二进制存储格式： 顺序文件、 Avro数据文件以及RCFile</h4><h3 id="导入数据"><a href="#导入数据" class="headerlink" title="导入数据"></a>导入数据</h3><h4 id="INSERT-语句"><a href="#INSERT-语句" class="headerlink" title="INSERT 语句"></a>INSERT 语句</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">INSERT</span> OVERWRITE <span class="keyword">TABLE</span> target</div><div class="line"><span class="keyword">SELECT</span> col1,col2</div><div class="line"><span class="keyword">FROM</span> <span class="keyword">source</span>;</div></pre></td></tr></table></figure>
<p>对于分区的表，可以使用PARTITION子句来指明数据要插入哪个分区</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">INSERT</span> OVERWRITE <span class="keyword">TABLE</span> target</div><div class="line"><span class="keyword">PARTITION</span> (dt=<span class="string">'2017-01-01'</span>)</div><div class="line"><span class="keyword">SELECT</span> col1,col2</div><div class="line"><span class="keyword">FROM</span> <span class="keyword">source</span>;</div></pre></td></tr></table></figure>
<h4 id="多表插入"><a href="#多表插入" class="headerlink" title="多表插入"></a>多表插入</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">FROM records2</div><div class="line"><span class="keyword">INSERT</span> OVERWRITE <span class="keyword">TABLE</span> stations_by_year</div><div class="line">  <span class="keyword">SELECT</span> <span class="keyword">year</span>, <span class="keyword">COUNT</span>(<span class="keyword">DISTINCT</span> station)</div><div class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">year</span></div><div class="line"><span class="keyword">INSERT</span> OVERWRITE <span class="keyword">TABLE</span> records_by_year</div><div class="line">  <span class="keyword">SELECT</span> <span class="keyword">year</span>, <span class="keyword">COUNT</span>(<span class="number">1</span>)</div><div class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">year</span></div><div class="line"><span class="keyword">INSERT</span> OVERWRITE <span class="keyword">TABLE</span> good_records_by_year</div><div class="line">  <span class="keyword">SELECT</span> <span class="keyword">year</span>,<span class="keyword">COUNT</span>(<span class="number">1</span>)</div><div class="line">  <span class="keyword">WHERE</span> temperature != <span class="number">9999</span></div><div class="line">    <span class="keyword">And</span> quality = <span class="number">0</span> <span class="keyword">OR</span> quality = <span class="number">1</span></div><div class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">year</span>;</div></pre></td></tr></table></figure>
<h4 id="CTAS"><a href="#CTAS" class="headerlink" title="CTAS"></a>CTAS</h4><p>CTAS 的操作是原子的</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> target</div><div class="line"><span class="keyword">AS</span></div><div class="line"><span class="keyword">SELECT</span> col1, col2</div><div class="line"><span class="keyword">FROM</span> <span class="keyword">source</span>;</div></pre></td></tr></table></figure>
<h3 id="表的修改"><a href="#表的修改" class="headerlink" title="表的修改"></a>表的修改</h3><p>重命名<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">source</span> <span class="keyword">RENAME</span> <span class="keyword">TO</span> target;</div></pre></td></tr></table></figure></p>
<p>添加一个新的列<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> target <span class="keyword">ADD</span> <span class="keyword">COLUMNS</span> (col3 <span class="keyword">STRING</span>);</div></pre></td></tr></table></figure></p>
<h3 id="表的丢弃"><a href="#表的丢弃" class="headerlink" title="表的丢弃"></a>表的丢弃</h3><ul>
<li>DROP TABLE 删除表的数据和元数据</li>
<li>dfs -rmr /user/hive/warehouse/my_table 删除数据</li>
<li>CREATE TABLE new_table LIKE existing_table; 创建一个与第一个表模式相同的新表</li>
</ul>
<h2 id="查询数据"><a href="#查询数据" class="headerlink" title="查询数据"></a>查询数据</h2><p>使用SELECT语句的各种形式从Hive中检索数据</p>
<h3 id="排序和聚集"><a href="#排序和聚集" class="headerlink" title="排序和聚集"></a>排序和聚集</h3><p>在Hive中可以使用ORDER BY 子句对数据进行排序，但是ORDER BY 只通过一个reducer来做到这点。<br>SORT BY为每个reducer产生一个排序文件。<br>DISTRIBUTE BY 控制特定行应该到那个reducer</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">hive&gt; FROM records2</div><div class="line">    &gt; SELECT year, temperature</div><div class="line">    &gt; DISTRIBUTE BY year</div><div class="line">    &gt; SORT BY year ASC, temperature DESC;</div><div class="line">1949 111</div><div class="line">1949 78</div><div class="line">1950 22</div><div class="line">1950 0</div><div class="line">1950 -11</div></pre></td></tr></table></figure>
<h3 id="MapReduce脚本"><a href="#MapReduce脚本" class="headerlink" title="MapReduce脚本"></a>MapReduce脚本</h3><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">hive&gt; ADD FILE /user/tom/book_workspace/scr.py;</div><div class="line">hive&gt; FROM records2</div><div class="line">    &gt; SELECT TRANSFORM(year, temperature, quality)</div><div class="line">    &gt; USING 'scr.py'</div><div class="line">    &gt; AS year, temperature;</div><div class="line">1950 0</div><div class="line">1950 22</div><div class="line">1950 -11</div><div class="line">1949 111</div><div class="line">1949 78</div></pre></td></tr></table></figure>
<h3 id="连接"><a href="#连接" class="headerlink" title="连接"></a>连接</h3><h4 id="内连接"><a href="#内连接" class="headerlink" title="内连接"></a>内连接</h4><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">hive&gt; SELECT sales.*, things.*</div><div class="line">    &gt; FROM sales JOIN things ON (sales.id = things.id);</div></pre></td></tr></table></figure>
<h4 id="外连接"><a href="#外连接" class="headerlink" title="外连接"></a>外连接</h4><p>left outer join</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">hive&gt; SELECT sales.*, things.*</div><div class="line">    &gt; FROM sales LEFT OUTER JOIN things ON (sales.id = things.id);</div></pre></td></tr></table></figure>
<p>除此之外还有一种”全外连接”(full outer join) “右外连接”(right outer join)</p>
<h4 id="半连接"><a href="#半连接" class="headerlink" title="半连接"></a>半连接</h4><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">hive&gt; SELECT *</div><div class="line">    &gt; FROM things LEFT SEMI JOIN sales ON (sales.id = things.id);</div></pre></td></tr></table></figure>
<p>右表只能在ON子句中出现</p>
<h4 id="map连接"><a href="#map连接" class="headerlink" title="map连接"></a>map连接</h4><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">hive&gt; SELECT /*+ MAPJOIN(things) */ sales.*, things.*</div><div class="line">    &gt; FROM sales JOIN things ON (sales.id = things.id);</div></pre></td></tr></table></figure>
<p>如果用map进行桶连接，设置<br>SET hive.optimize.bucketmapjoin=true;</p>
<h3 id="子查询"><a href="#子查询" class="headerlink" title="子查询"></a>子查询</h3><p>hive 的子查询只能出现from子句中</p>
<h3 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> v_records</div><div class="line"><span class="keyword">AS</span></div><div class="line"><span class="keyword">SELECT</span> *</div><div class="line"><span class="keyword">FROM</span> records2</div><div class="line"><span class="keyword">WHERE</span> temperature != <span class="number">9999</span></div><div class="line">  <span class="keyword">AND</span> (quality = <span class="number">0</span> <span class="keyword">OR</span> quality = <span class="number">1</span>);</div></pre></td></tr></table></figure>
<p>创建视图并不执行查询，只有用到的时候才会执行。</p>
<h2 id="用户自定义函数"><a href="#用户自定义函数" class="headerlink" title="用户自定义函数"></a>用户自定义函数</h2><p>UDF分为三种</p>
<ul>
<li>普通UDF 作用于单个数据行，产生一个数据行</li>
<li>UDAF 接受多个输入数据行，产生一个数据行</li>
<li>UDTF 作用于单个数据行，产生多个数据行</li>
</ul>
<h3 id="写UDF"><a href="#写UDF" class="headerlink" title="写UDF"></a>写UDF</h3><p>一个UDF必须：</p>
<ol>
<li>是org.apache.hadoop.hive.ql.exec.UDF的子类</li>
<li>至少实现一个evaluate()方法</li>
</ol>
<p>返回String类型时最好使用可以对象重用的TEXT类</p>
<p>写好后打包<br>ADD JAR /path/to/hive-examples.jar;</p>
<p>起个别名<br>CREATE TEMPORARY FUNCTION function_name AS ‘com.hadoopbook.hive.function_name’;</p>
<p>只对临时hive会话有效</p>
<h3 id="写UDAF"><a href="#写UDAF" class="headerlink" title="写UDAF"></a>写UDAF</h3><p><img src="/images/udaf.png" alt="UDAF"></p>
<p>一个计算函数必须实现下面5个方法</p>
<ul>
<li>init() 负责初始化计算函数并重设它的内部状态</li>
<li>interate() 每次对一个新值进行聚集计算都会调用iterate()方法</li>
<li>terminatePartial() Hive 需要部分聚集结果是会调用 terminatePartial()方法</li>
<li>merge() 在Hive决定要合并一个部分聚集值和另一个部分聚集值时会调用merge()方法</li>
<li>terminate() Hive需要最终聚集结果时会调用terminate()方法</li>
</ul>
<p>更加复杂的返回类型可以定义一个数据类来实现。</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/hive/" rel="tag"># hive</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/06/28/MapReduce的InputFormat/" rel="next" title="MapReduce的InputFormat">
                <i class="fa fa-chevron-left"></i> MapReduce的InputFormat
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/07/21/java虚拟机/" rel="prev" title="java虚拟机工作原理">
                java虚拟机工作原理 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="黄文启" />
          <p class="site-author-name" itemprop="name">黄文启</p>
           
              <p class="site-description motion-element" itemprop="description">有花堪折直须折 莫待无花空折枝</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">26</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">17</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/atqi" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://facebook.com/atqigg" target="_blank" title="Facebook">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Facebook
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Hive-QL"><span class="nav-number">1.</span> <span class="nav-text">Hive QL</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#数据类型"><span class="nav-number">1.1.</span> <span class="nav-text">数据类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#复杂类型"><span class="nav-number">1.2.</span> <span class="nav-text">复杂类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#操作与函数"><span class="nav-number">1.3.</span> <span class="nav-text">操作与函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#类型转换"><span class="nav-number">1.3.1.</span> <span class="nav-text">类型转换</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#表"><span class="nav-number">2.</span> <span class="nav-text">表</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#托管表和外部表"><span class="nav-number">2.1.</span> <span class="nav-text">托管表和外部表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分区和桶"><span class="nav-number">2.2.</span> <span class="nav-text">分区和桶</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#桶"><span class="nav-number">2.2.1.</span> <span class="nav-text">桶</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#存储格式"><span class="nav-number">2.3.</span> <span class="nav-text">存储格式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#二进制存储格式：-顺序文件、-Avro数据文件以及RCFile"><span class="nav-number">2.3.1.</span> <span class="nav-text">二进制存储格式： 顺序文件、 Avro数据文件以及RCFile</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#导入数据"><span class="nav-number">2.4.</span> <span class="nav-text">导入数据</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#INSERT-语句"><span class="nav-number">2.4.1.</span> <span class="nav-text">INSERT 语句</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#多表插入"><span class="nav-number">2.4.2.</span> <span class="nav-text">多表插入</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CTAS"><span class="nav-number">2.4.3.</span> <span class="nav-text">CTAS</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#表的修改"><span class="nav-number">2.5.</span> <span class="nav-text">表的修改</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#表的丢弃"><span class="nav-number">2.6.</span> <span class="nav-text">表的丢弃</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#查询数据"><span class="nav-number">3.</span> <span class="nav-text">查询数据</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#排序和聚集"><span class="nav-number">3.1.</span> <span class="nav-text">排序和聚集</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MapReduce脚本"><span class="nav-number">3.2.</span> <span class="nav-text">MapReduce脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#连接"><span class="nav-number">3.3.</span> <span class="nav-text">连接</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#内连接"><span class="nav-number">3.3.1.</span> <span class="nav-text">内连接</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#外连接"><span class="nav-number">3.3.2.</span> <span class="nav-text">外连接</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#半连接"><span class="nav-number">3.3.3.</span> <span class="nav-text">半连接</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#map连接"><span class="nav-number">3.3.4.</span> <span class="nav-text">map连接</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#子查询"><span class="nav-number">3.4.</span> <span class="nav-text">子查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#视图"><span class="nav-number">3.5.</span> <span class="nav-text">视图</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#用户自定义函数"><span class="nav-number">4.</span> <span class="nav-text">用户自定义函数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#写UDF"><span class="nav-number">4.1.</span> <span class="nav-text">写UDF</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#写UDAF"><span class="nav-number">4.2.</span> <span class="nav-text">写UDAF</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">黄文启</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'dis-13';
      var disqus_identifier = '2017/07/07/Hive/';

      var disqus_title = "Hive";


      function run_disqus_script(disqus_script) {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');

      
        var disqus_config = function () {
            this.page.url = disqus_url;
            this.page.identifier = disqus_identifier;
            this.page.title = disqus_title;
        };
        run_disqus_script('embed.js');
      

    </script>
  










  
  

  

  

  

  

  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.0"></script>



  

</body>
</html>
